# 视频服务 - 递归扫描增强版

一个支持 HTTPS、IPv6/IPv4、递归扫描、视频ID隐藏的Node.js视频服务器。

## 主要特性

### 核心功能
- **递归扫描**：自动扫描所有子目录，支持任意深度的目录结构
- **路径显示**：清晰展示视频文件的相对路径
- **视频ID隐藏**：使用哈希ID代替文件名，保护隐私
- **POST请求传输**：视频流通过POST请求，避免URL暴露
- **用户认证**：基于Cookie的会话管理
- **HTTPS支持**：支持SSL/TLS加密传输
- **多目录支持**：可配置多个视频目录

### 支持的视频格式
- MP4 (.mp4)
- MKV (.mkv)
- AVI (.avi)
- MOV (.mov)
- WebM (.webm)

## 安装和使用

### 1. 安装依赖

```bash
npm install
```

### 2. 配置

编辑 `config.json` 文件：

```json
{
  "users": [
    {
      "username": "admin",
      "password": "password123"
    }
  ],
  "port": 18899,
  "host": "::",
  "https": {
    "enabled": true,
    "key": "./key.pem",
    "cert": "./cert.pem"
  },
  "videoDirs": [
    {
      "name": "我的视频",
      "path": "/path/to/your/videos"
    }
  ]
}
```

### 3. 生成SSL证书（启用HTTPS时需要）

**macOS/Linux:**
```bash
./generate-cert.sh
```

**Windows:**
```cmd
generate-cert.bat
```

### 4. 启动服务

```bash
npm start
```

### 5. 访问服务

- **HTTPS**: https://127.0.0.1:18899
- **HTTP**: http://127.0.0.1:18899 (如果禁用HTTPS)

## 目录结构支持

程序会递归扫描所有子目录，支持任意深度的目录结构：

```
视频目录/
├── 电影/
│   ├── 动作片/
│   │   ├── 复仇者联盟.mp4
│   │   └── 钢铁侠.mp4
│   └── 喜剧片/
│       ├── 功夫.mp4
│       └── 大话西游.mp4
├── 电视剧/
│   ├── 国产剧/
│   │   ├── 琅琊榜.mp4
│   │   └── 庆余年.mp4
│   └── 美剧/
│       └── 权力的游戏.mp4
├── 动画/
│   ├── 千与千寻.mp4
│   └── 你的名字.mp4
└── 纪录片/
    └── 地球脉动.mp4
```

**所有视频文件都会被自动扫描到！**

## 页面显示

### 视频列表页面

```
共找到 10 个视频文件，来自 1 个目录

📁 我的视频 (10 个视频)
├── 📂 电影/动作片/复仇者联盟.mp4
│   复仇者联盟.mp4  大小: 2.3 GB | 修改时间: 2024-01-15
├── 📂 电视剧/国产剧/琅琊榜.mp4
│   琅琊榜.mp4  大小: 8.5 GB | 修改时间: 2024-01-20
└── 纪录片/地球脉动.mp4  大小: 4.2 GB | 修改时间: 2024-01-25
```

**显示规则：**
- 根目录视频：只显示文件名
- 子目录视频：显示相对路径 + 文件名

### 视频播放页面

```
🔒 视频ID: a3f5b2c1... (文件名已隐藏)
📁 我的视频

复仇者联盟.mp4        ← 返回列表
────────────────────────────────────────────
[视频播放器]
```

## 功能特性详解

### 递归扫描

✅ 自动扫描所有子目录
✅ 支持任意深度的目录结构
✅ 显示视频文件的相对路径
✅ 支持跨平台路径格式
✅ 快速扫描，适合大量文件

### 安全性

✅ URL中不包含文件名
✅ 使用哈希ID代替文件路径
✅ POST请求传输视频流
✅ 需要登录认证
✅ 自动清理过期的视频ID

### 用户体验

✅ 清晰的路径显示
✅ 按目录分组显示
✅ 响应式设计
✅ 支持视频拖动进度条
✅ 在线视频播放

## 远程访问

### 查看本机IP地址

**macOS/Linux:**
```bash
ifconfig | grep "inet "
```

**Windows:**
```cmd
ipconfig
```

### 从远程设备访问

- IPv4: `https://<本机IPv4地址>:18899`
- IPv6: `https://[<本机IPv6地址>]:18899`

## 测试递归扫描功能

运行测试脚本：

```bash
./test-recursive-scan.sh
```

这会创建一个测试目录结构，包含多层子目录和测试视频文件。

## 常见问题

**Q: 程序能扫描多深的目录？**

A: 理论上无限制，建议不超过10层。

**Q: 支持多少个视频文件？**

A: 已测试1000+视频文件无问题。

**Q: 子目录中的视频会显示吗？**

A: 会，程序会递归扫描所有子目录。

**Q: 不同目录中的同名视频会冲突吗？**

A: 不会，每个视频都有独立的哈希ID。

**Q: 如何禁用HTTPS？**

A: 将 `config.json` 中 `https.enabled` 设置为 `false`。

**Q: 扫描速度如何？**

A: 同步扫描，适合中小型视频库（< 10000文件）。

**Q: 支持Windows路径吗？**

A: 支持，路径分隔符会自动转换。

## 技术实现

- **递归扫描**：使用深度优先搜索算法
- **路径处理**：跨平台路径转换
- **哈希ID**：SHA-256算法生成唯一ID
- **会话管理**：Cookie-based会话
- **视频流**：POST请求传输
- **HTTPS**：Node.js内置https模块

## 性能建议

1. **视频数量**：建议 < 10000 个视频文件
2. **目录深度**：建议 < 10 层
3. **文件大小**：支持任意大小
4. **网络带宽**：建议 >= 10Mbps

## 安全建议

1. 使用强密码
2. 定期更换密码
3. 配置防火墙
4. 使用正式SSL证书（生产环境）
5. 限制远程访问IP

## 故障排除

**问题：找不到视频文件**

- 检查目录路径是否正确
- 检查文件扩展名是否支持
- 检查文件权限是否正确
- 查看服务器日志

**问题：视频无法播放**

- 检查视频文件是否损坏
- 检查浏览器是否支持该格式
- 检查网络连接
- 尝试刷新页面

**问题：扫描速度慢**

- 减少视频文件数量
- 优化目录结构
- 升级服务器硬件

## 更新日志

### v2.0 - 递归扫描增强
- ✅ 添加递归扫描功能
- ✅ 显示视频相对路径
- ✅ 支持多层目录结构
- ✅ 优化扫描性能
- ✅ 添加扫描日志

### v1.0 - 初始版本
- ✅ HTTPS支持
- ✅ 视频ID隐藏
- ✅ 多目录支持
- ✅ 用户认证
- ✅ IPv6/IPv4双栈

## 许可证

MIT License
