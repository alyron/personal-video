<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘åˆ—è¡¨ - è§†é¢‘æœåŠ¡å™¨</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            background: #e0e0e0;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        .video-item .favorite-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ff6b6b;
            font-size: 18px;
        }
        .video-item {
            position: relative;
        }
        /* æ’åºæŒ‰é’® */
        .sort-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sort-btn:hover {
            background: #f5f5f5;
        }
        .sort-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .toolbar-left {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">ğŸ“¹ è§†é¢‘æœåŠ¡å™¨</h1>
        <div class="header-info">
            <span class="user-badge" id="userBadge">ğŸ‘¤ åŠ è½½ä¸­...</span>
            <button id="refreshBtn" class="refresh-btn">åˆ·æ–°æ‰«æ</button>
            <button id="generatePinBtn" class="pin-btn">ğŸ”‘ PINç </button>
            <a href="/api/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </header>

    <main class="main-content">
        <div class="tabs">
            <button class="tab-btn active" data-tab="all" onclick="switchTab('all')">å…¨éƒ¨è§†é¢‘</button>
            <button class="tab-btn" data-tab="favorites" onclick="switchTab('favorites')">â¤ æˆ‘çš„æ”¶è—</button>
        </div>

        <div class="toolbar">
            <div class="toolbar-left">
                <button class="sort-btn" id="sortBySizeBtn" onclick="toggleSortBySize()">
                    <span>ğŸ“Š</span> æŒ‰å®¹é‡æ’åº
                </button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="videoCount">0</div>
                <div class="stat-label" id="videoLabel">è§†é¢‘æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="dirCount">0</div>
                <div class="stat-label" id="dirLabel">ç›®å½•æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-label" id="scanStatus">æ£€æŸ¥çŠ¶æ€ä¸­...</div>
            </div>
        </div>

        <div class="video-list-wrapper">
            <div class="video-list" id="videoList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
            <div class="quick-nav" id="quickNav" style="display: none;"></div>
        </div>
        <!-- å…¨å±€é¡µé¢æ»šåŠ¨æ¡æ»‘å— -->
        <div class="page-slider" id="pageSlider">
            <div class="page-slider-track">
                <div class="page-slider-thumb" id="pageSliderThumb"></div>
            </div>
        </div>
        <div class="quick-nav-tooltip" id="quickNavTooltip"></div>
    </main>

    <!-- PINç å¼¹çª— -->
    <div class="pin-modal" id="pinModal">
        <div class="pin-modal-content">
            <h3 class="pin-modal-title">PINç ç™»å½•</h3>
            <p class="pin-modal-hint">è¯·åœ¨å…¶ä»–è®¾å¤‡ä¸Šè¾“å…¥æ­¤PINç ç™»å½•</p>
            <div class="pin-code-display" id="pinCodeDisplay">
                <div class="pin-digit">-</div>
                <div class="pin-digit">-</div>
                <div class="pin-digit">-</div>
                <div class="pin-digit">-</div>
            </div>
            <p class="pin-timer" id="pinTimer">æœ‰æ•ˆæœŸ: 5:00</p>
            <button class="pin-modal-close" id="pinModalClose">å…³é—­</button>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentTab = 'all';
        let allVideos = [];
        let favorites = [];
        let sortBySize = false; // æ˜¯å¦æŒ‰å®¹é‡æ’åº

        // è§£ææ–‡ä»¶å¤§å°å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°
        function parseSizeToBytes(sizeStr) {
            if (!sizeStr) return 0;
            const match = sizeStr.match(/([\d.]+)\s*(GB|MB|KB|TB|B)/i);
            if (!match) return 0;

            const value = parseFloat(match[1]);
            const unit = match[2].toUpperCase();

            const units = { 'B': 1, 'KB': 1024, 'MB': 1024 ** 2, 'GB': 1024 ** 3, 'TB': 1024 ** 4 };
            return value * (units[unit] || 1);
        }

        // åˆ‡æ¢æŒ‰å®¹é‡æ’åº
        function toggleSortBySize() {
            sortBySize = !sortBySize;
            const btn = document.getElementById('sortBySizeBtn');
            btn.classList.toggle('active', sortBySize);

            if (currentTab === 'all') {
                renderVideoList(allVideos);
            }
        }

        // ç»Ÿä¸€ API è¯·æ±‚å¤„ç†
        async function api(url, options = {}) {
            const response = await fetch(url, { 
                ...options,
                credentials: 'same-origin'
            });
            
            if (response.status === 401) {
                window.location.href = '/login.html';
                throw new Error('æœªç™»å½•');
            }
            
            return response;
        }

        // åˆ‡æ¢æ ‡ç­¾
        async function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // æ›´æ–°ç»Ÿè®¡æ ‡ç­¾
            document.getElementById('videoLabel').textContent = tab === 'all' ? 'è§†é¢‘æ€»æ•°' : 'æ”¶è—æ•°é‡';
            document.getElementById('dirLabel').textContent = tab === 'all' ? 'ç›®å½•æ•°' : 'æ¥æºç›®å½•';
            
            // æ¸²æŸ“å¯¹åº”åˆ—è¡¨
            if (tab === 'all') {
                renderVideoList(allVideos);
            } else {
                // åŠ è½½æ”¶è—
                await loadFavorites();
            }
        }

        // åŠ è½½æ”¶è—åˆ—è¡¨
        async function loadFavorites() {
            const videoList = document.getElementById('videoList');
            const quickNav = document.getElementById('quickNav');
            
            // éšè—å¿«é€Ÿå¯¼èˆª
            quickNav.style.display = 'none';
            
            try {
                const response = await api('/api/favorites');
                const data = await response.json();
                favorites = data.favorites || [];
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('videoCount').textContent = favorites.length;
                const dirs = [...new Set(favorites.map(f => f.dirName))];
                document.getElementById('dirCount').textContent = dirs.length;
                
                if (favorites.length === 0) {
                    videoList.innerHTML = `
                        <div class="empty-state">
                            <h3>æš‚æ— æ”¶è—</h3>
                            <p>åœ¨è§†é¢‘æ’­æ”¾é¡µé¢ç‚¹å‡»"æ”¶è—"æŒ‰é’®æ·»åŠ æ”¶è—</p>
                        </div>
                    `;
                    return;
                }
                
                // æ¸²æŸ“æ”¶è—åˆ—è¡¨
                let html = '<div class="video-group"><div class="group-content">';
                
                favorites.forEach(video => {
                    html += `
                        <div class="video-item">
                            <div class="video-info">
                                <div class="video-path">ğŸ“ ${video.dirName}</div>
                                <div class="video-name">${video.filename}</div>
                                <div class="video-meta">æ”¶è—äº: ${formatTimestamp(video.addedAt)}</div>
                            </div>
                            <a href="/player.html?id=${video.videoId}" class="watch-btn" target="_blank">æ’­æ”¾</a>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                videoList.innerHTML = html;

            } catch (err) {
                videoList.innerHTML = `
                    <div class="empty-state">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
        function renderVideoList(videos) {
            const videoList = document.getElementById('videoList');
            const quickNav = document.getElementById('quickNav');

            if (videos.length === 0) {
                videoList.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— è§†é¢‘</h3>
                        <p>ç‚¹å‡»"åˆ·æ–°æ‰«æ"æŒ‰é’®æ‰«æè§†é¢‘ç›®å½•</p>
                    </div>
                `;
                quickNav.style.display = 'none';
                return;
            }

            // å¦‚æœæŒ‰å®¹é‡æ’åºï¼Œå…ˆæŒ‰å¤§å°æ’åºï¼ˆä¿æŒç›®å½•åˆ†ç»„ï¼Œä½†ç»„å†…æŒ‰å¤§å°æ’åºï¼‰
            let videosToRender = [...videos];
            if (sortBySize) {
                videosToRender.sort((a, b) => parseSizeToBytes(b.size) - parseSizeToBytes(a.size));
            }

            // æŒ‰ç›®å½•åˆ†ç»„
            const grouped = {};
            videosToRender.forEach(video => {
                if (!grouped[video.dirName]) {
                    grouped[video.dirName] = [];
                }
                grouped[video.dirName].push(video);
            });
            
            // è·å–æ”¶è—çš„è§†é¢‘IDåˆ—è¡¨
            const favoriteIds = new Set(favorites.map(f => f.videoId));
            
            // ç›®å½•åç§°åˆ—è¡¨ï¼ˆç”¨äºå¿«é€Ÿå¯¼èˆªï¼‰
            const dirNames = Object.keys(grouped);
            
            let html = '';
            for (const [dirName, vids] of Object.entries(grouped)) {
                // æ·»åŠ  id ä»¥ä¾¿å¿«é€Ÿå¯¼èˆªå®šä½
                const dirId = 'dir-' + dirName.replace(/[^a-zA-Z0-9]/g, '_');
                html += `
                    <div class="video-group" id="${dirId}">
                        <div class="group-header" onclick="toggleGroup(this)">
                            <span class="group-name">ğŸ“ ${dirName}</span>
                            <span class="group-count">${vids.length} ä¸ªè§†é¢‘</span>
                        </div>
                        <div class="group-content">
                            ${vids.map(video => {
                                const displayPath = video.relativePath.replace(/\\\\/g, '/');
                                const isFav = favoriteIds.has(video.id);
                                return `
                                    <div class="video-item">
                                        <div class="video-info">
                                            ${displayPath !== video.name ? `<div class="video-path">ğŸ“‚ ${displayPath}</div>` : ''}
                                            <div class="video-name">${video.name} ${isFav ? '<span style="color:#ff6b6b">â™¥</span>' : ''}</div>
                                            <div class="video-meta">å¤§å°: ${video.size} | ä¿®æ”¹æ—¶é—´: ${video.modified}</div>
                                        </div>
                                        <a href="/player.html?id=${video.id}" class="watch-btn" target="_blank">æ’­æ”¾</a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            videoList.innerHTML = html;

            // ç”Ÿæˆå¿«é€Ÿå¯¼èˆªæ»‘å—
            renderQuickNav(dirNames);
        }
        
        // æ¸²æŸ“å¿«é€Ÿå¯¼èˆªæ»‘å—
        function renderQuickNav(dirNames) {
            const quickNav = document.getElementById('quickNav');
            const tooltip = document.getElementById('quickNavTooltip');
            
            // å­˜å‚¨ç›®å½•åç§°ä¾›æ‹–åŠ¨ä½¿ç”¨
            window._quickNavDirNames = dirNames;
            
            if (dirNames.length <= 3) {
                quickNav.style.display = 'none';
                return;
            }
            
            quickNav.style.display = 'flex';
            quickNav.innerHTML = '';
            
            dirNames.forEach((dirName, index) => {
                const item = document.createElement('div');
                item.className = 'quick-nav-item';
                
                // æ˜¾ç¤ºç›®å½•åé¦–å­—ç¬¦æˆ–ç®€ç§°
                const shortName = dirName.length <= 2 ? dirName : dirName.substring(0, 2);
                item.textContent = shortName;
                item.title = dirName;
                item.dataset.index = index;
                item.dataset.dirName = dirName;
                
                // ç‚¹å‡»è·³è½¬
                item.addEventListener('click', () => {
                    const dirId = 'dir-' + dirName.replace(/[^a-zA-Z0-9]/g, '_');
                    const target = document.getElementById(dirId);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        updateActiveNav(index);
                    }
                });
                
                quickNav.appendChild(item);
            });
            
            // è®¾ç½®æ‹–åŠ¨æ”¯æŒ
            setupQuickNavDrag(quickNav, tooltip, dirNames);
            
            // æ»šåŠ¨ç›‘å¬ï¼Œæ›´æ–°å½“å‰é«˜äº®
            setupScrollObserver();
        }
        
        // è®¾ç½®å¿«é€Ÿå¯¼èˆªæ‹–åŠ¨
        function setupQuickNavDrag(quickNav, tooltip, dirNames) {
            let isDragging = false;
            
            const handleDrag = (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                
                const rect = quickNav.getBoundingClientRect();
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                const relativeY = clientY - rect.top;
                const percentage = Math.max(0, Math.min(1, relativeY / rect.height));
                const index = Math.floor(percentage * dirNames.length);
                const clampedIndex = Math.min(index, dirNames.length - 1);
                
                const dirName = dirNames[clampedIndex];
                const dirId = 'dir-' + dirName.replace(/[^a-zA-Z0-9]/g, '_');
                const target = document.getElementById(dirId);
                
                // æ˜¾ç¤ºæç¤º
                tooltip.textContent = dirName;
                tooltip.style.top = (rect.top + relativeY) + 'px';
                tooltip.classList.add('show');
                
                // æ»šåŠ¨åˆ°ç›®æ ‡
                if (target) {
                    target.scrollIntoView({ behavior: 'auto', block: 'start' });
                    updateActiveNav(clampedIndex);
                }
            };
            
            const startDrag = (e) => {
                isDragging = true;
                document.body.style.userSelect = 'none';
                handleDrag(e);
            };
            
            const endDrag = () => {
                isDragging = false;
                document.body.style.userSelect = '';
                tooltip.classList.remove('show');
            };
            
            quickNav.addEventListener('mousedown', startDrag);
            quickNav.addEventListener('touchstart', startDrag, { passive: false });
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('touchmove', handleDrag, { passive: false });
            
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }
        
        // æ›´æ–°å¯¼èˆªé«˜äº®
        function updateActiveNav(activeIndex) {
            const items = document.querySelectorAll('.quick-nav-item');
            items.forEach((item, i) => {
                item.classList.toggle('active', i === activeIndex);
            });
        }
        
        // è®¾ç½®æ»šåŠ¨ç›‘å¬
        function setupScrollObserver() {
            const groups = document.querySelectorAll('.video-group');
            const quickNav = document.getElementById('quickNav');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const dirName = entry.target.id.replace('dir-', '').replace(/_/g, ' ');
                        const items = document.querySelectorAll('.quick-nav-item');
                        items.forEach(item => {
                            const itemDirId = 'dir-' + item.dataset.dirName.replace(/[^a-zA-Z0-9]/g, '_');
                            item.classList.toggle('active', itemDirId === entry.target.id);
                        });
                    }
                });
            }, {
                rootMargin: '-80px 0px -70% 0px',
                threshold: 0
            });
            
            groups.forEach(group => observer.observe(group));
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨
        async function loadVideoList() {
            const videoList = document.getElementById('videoList');
            
            try {
                // å¹¶è¡ŒåŠ è½½è§†é¢‘åˆ—è¡¨å’Œæ”¶è—åˆ—è¡¨
                const [videosRes, favRes] = await Promise.all([
                    api('/api/videos'),
                    api('/api/favorites')
                ]);
                
                const data = await videosRes.json();
                const favData = await favRes.json();
                
                allVideos = data.videos;
                favorites = favData.favorites || [];
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('videoCount').textContent = data.videoCount;
                document.getElementById('dirCount').textContent = data.dirCount;
                
                renderVideoList(allVideos);
                
            } catch (err) {
                videoList.innerHTML = `
                    <div class="empty-state">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        // åˆ·æ–°æ‰«æ
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'æ‰«æä¸­...';
            
            try {
                const response = await api('/api/scan', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    await loadVideoList();
                } else {
                    alert('æ‰«æå¤±è´¥: ' + result.error);
                }
            } catch (err) {
                if (err.message !== 'æœªç™»å½•') {
                    alert('è¯·æ±‚å¤±è´¥: ' + err.message);
                }
            } finally {
                this.disabled = false;
                this.textContent = 'åˆ·æ–°æ‰«æ';
            }
        });

        // åˆ‡æ¢ç›®å½•å±•å¼€/æ”¶èµ·
        function toggleGroup(header) {
            const content = header.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        // ==================== PINç ç”Ÿæˆ ====================
        let pinTimerInterval = null;
        let pinExpiresAt = null;

        // ç”ŸæˆPINç æŒ‰é’®ç‚¹å‡»
        document.getElementById('generatePinBtn').addEventListener('click', async () => {
            try {
                const response = await api('/api/pin/generate', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showPinModal(result.pin, result.expiresAt);
                } else {
                    alert('ç”ŸæˆPINç å¤±è´¥: ' + result.error);
                }
            } catch (err) {
                if (err.message !== 'æœªç™»å½•') {
                    alert('è¯·æ±‚å¤±è´¥: ' + err.message);
                }
            }
        });

        // æ˜¾ç¤ºPINç å¼¹çª—
        function showPinModal(pin, expiresAt) {
            const modal = document.getElementById('pinModal');
            const display = document.getElementById('pinCodeDisplay');
            const timer = document.getElementById('pinTimer');

            // æ˜¾ç¤ºPINç 
            display.innerHTML = pin.split('').map(d => `<div class="pin-digit">${d}</div>`).join('');

            // è®¾ç½®è¿‡æœŸæ—¶é—´
            pinExpiresAt = expiresAt;

            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (pinTimerInterval) {
                clearInterval(pinTimerInterval);
            }

            // æ›´æ–°å€’è®¡æ—¶
            function updateTimer() {
                const remaining = Math.max(0, pinExpiresAt - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                timer.textContent = `æœ‰æ•ˆæœŸ: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                timer.classList.toggle('warning', remaining < 60000);

                if (remaining <= 0) {
                    clearInterval(pinTimerInterval);
                    timer.textContent = 'PINç å·²è¿‡æœŸ';
                    timer.classList.add('warning');
                }
            }

            updateTimer();
            pinTimerInterval = setInterval(updateTimer, 1000);

            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('show');
        }

        // å…³é—­PINç å¼¹çª—
        document.getElementById('pinModalClose').addEventListener('click', () => {
            const modal = document.getElementById('pinModal');
            modal.classList.remove('show');
            if (pinTimerInterval) {
                clearInterval(pinTimerInterval);
                pinTimerInterval = null;
            }
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('pinModal').addEventListener('click', (e) => {
            if (e.target.id === 'pinModal') {
                document.getElementById('pinModalClose').click();
            }
        });

        // å…¨å±€é¡µé¢æ»šåŠ¨æ¡æ»‘å—
        function initPageSlider() {
            const pageSlider = document.getElementById('pageSlider');
            const thumb = document.getElementById('pageSliderThumb');

            let isDragging = false;

            function updateThumb() {
                const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                const maxScroll = scrollHeight - clientHeight;

                if (maxScroll <= 10) {
                    pageSlider.style.display = 'none';
                    return;
                }

                pageSlider.style.display = 'block';
                const percentage = scrollTop / maxScroll;
                const trackHeight = pageSlider.clientHeight;
                const thumbHeight = Math.max(40, (clientHeight / scrollHeight) * trackHeight);
                const maxThumbTop = trackHeight - thumbHeight;
                const thumbTop = percentage * maxThumbTop;

                thumb.style.height = thumbHeight + 'px';
                thumb.style.top = thumbTop + 'px';
            }

            // ç›‘å¬é¡µé¢æ»šåŠ¨
            window.addEventListener('scroll', () => {
                if (!isDragging) {
                    updateThumb();
                }
            });

            // æ»‘å—æ‹–åŠ¨
            thumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                thumb.classList.add('dragging');
                pageSlider.classList.add('dragging');
                document.body.style.userSelect = 'none';
            });

            // ç‚¹å‡»è½¨é“è·³è½¬
            pageSlider.addEventListener('mousedown', (e) => {
                if (e.target === pageSlider || e.target === thumb.parentElement) {
                    const rect = pageSlider.getBoundingClientRect();
                    const relativeY = e.clientY - rect.top;
                    const percentage = relativeY / rect.height;
                    const maxScroll = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                    window.scrollTo(0, percentage * maxScroll);
                    updateThumb();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const rect = pageSlider.getBoundingClientRect();
                const relativeY = e.clientY - rect.top;
                const percentage = Math.max(0, Math.min(1, relativeY / rect.height));
                const maxScroll = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                window.scrollTo(0, percentage * maxScroll);
                updateThumb();
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                thumb.classList.remove('dragging');
                pageSlider.classList.remove('dragging');
                document.body.style.userSelect = '';
            });

            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            thumb.addEventListener('touchstart', (e) => {
                isDragging = true;
                thumb.classList.add('dragging');
                pageSlider.classList.add('dragging');
            }, { passive: true });

            pageSlider.addEventListener('touchstart', (e) => {
                if (e.target === pageSlider || e.target === thumb.parentElement) {
                    const rect = pageSlider.getBoundingClientRect();
                    const touch = e.touches[0];
                    const relativeY = touch.clientY - rect.top;
                    const percentage = relativeY / rect.height;
                    const maxScroll = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                    window.scrollTo(0, percentage * maxScroll);
                    updateThumb();
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                const rect = pageSlider.getBoundingClientRect();
                const touch = e.touches[0];
                const relativeY = touch.clientY - rect.top;
                const percentage = Math.max(0, Math.min(1, relativeY / rect.height));
                const maxScroll = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                window.scrollTo(0, percentage * maxScroll);
                updateThumb();
            }, { passive: true });

            document.addEventListener('touchend', () => {
                isDragging = false;
                thumb.classList.remove('dragging');
                pageSlider.classList.remove('dragging');
            });

            // çª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°
            window.addEventListener('resize', updateThumb);

            // åˆå§‹æ›´æ–°
            updateThumb();
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            try {
                const userRes = await api('/api/user');
                if (!userRes.ok) throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                const userData = await userRes.json();
                document.getElementById('userBadge').textContent = `ğŸ‘¤ ${userData.username}`;
            } catch (err) {
                return;
            }

            // åŠ è½½è§†é¢‘åˆ—è¡¨
            await loadVideoList();

            // åˆå§‹åŒ–å…¨å±€é¡µé¢æ»šåŠ¨æ¡æ»‘å—
            initPageSlider();

            // è½®è¯¢æ‰«æçŠ¶æ€
            pollScanStatus();
        });
    </script>
</body>
</html>
