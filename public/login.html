<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <h1>服务器</h1>
        
        <!-- 登录方式切换 -->
        <div class="login-tabs">
            <button class="login-tab active" data-tab="password">密码登录</button>
            <button class="login-tab" data-tab="qrcode">扫码登录</button>
            <button class="login-tab" data-tab="pin">PIN码登录</button>
        </div>
        
        <!-- 密码登录表单 -->
        <form id="loginForm" class="login-form active" action="/api/login" method="POST" autocomplete="on">
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" required autofocus autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <p class="error-message" id="errorMsg" style="display: none;"></p>
            <button type="submit" class="login-btn">登录</button>
        </form>
        
        <!-- 扫码登录区域 -->
        <div id="qrcodeForm" class="login-form">
            <div class="qrcode-wrapper">
                <div id="qrcodeContainer" class="qrcode-box">
                    <div class="loading-spinner"></div>
                </div>
                <div id="qrcodeStatus" class="qrcode-status">
                    <p>请使用手机扫描二维码登录</p>
                </div>
            </div>
            <p class="error-message" id="qrErrorMsg" style="display: none;"></p>
            <button type="button" class="login-btn refresh-qrcode" id="refreshQR" style="display: none;">
                刷新二维码
            </button>
        </div>
        
        <!-- PIN码登录区域 -->
        <div id="pinForm" class="login-form">
            <div class="pin-wrapper">
                <div class="pin-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <p class="pin-description">请输入手机上显示的4位PIN码</p>
                <div class="pin-input-group">
                    <input type="text" id="pinInput1" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="text" id="pinInput2" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="text" id="pinInput3" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="text" id="pinInput4" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                </div>
                <p class="error-message" id="pinErrorMsg" style="display: none;"></p>
                <button type="button" class="login-btn" id="pinLoginBtn">登录</button>
            </div>
        </div>
    </div>
    
    <script>
        // 登录方式切换
        const tabs = document.querySelectorAll('.login-tab');
        const passwordForm = document.getElementById('loginForm');
        const qrcodeForm = document.getElementById('qrcodeForm');
        const pinForm = document.getElementById('pinForm');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (tab.dataset.tab === 'password') {
                    passwordForm.classList.add('active');
                    qrcodeForm.classList.remove('active');
                    pinForm.classList.remove('active');
                    stopQRCodePolling();
                } else if (tab.dataset.tab === 'qrcode') {
                    passwordForm.classList.remove('active');
                    qrcodeForm.classList.add('active');
                    pinForm.classList.remove('active');
                    initQRCode();
                } else {
                    passwordForm.classList.remove('active');
                    qrcodeForm.classList.remove('active');
                    pinForm.classList.add('active');
                    stopQRCodePolling();
                    document.getElementById('pinInput1').focus();
                }
            });
        });
        
        // 检查URL参数中的错误
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) {
            document.getElementById('errorMsg').textContent = '用户名或密码错误';
            document.getElementById('errorMsg').style.display = 'block';
        }
        
        // 自动填充已保存的凭据
        async function autoFillCredentials() {
            if (navigator.credentials) {
                try {
                    const credential = await navigator.credentials.get({
                        password: true,
                        mediation: 'silent'
                    });
                    if (credential) {
                        document.getElementById('username').value = credential.id;
                        document.getElementById('password').focus();
                    }
                } catch (e) {
                    // 忽略错误
                }
            }
        }
        autoFillCredentials();

        // 登录表单提交
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'same-origin'
                });

                const result = await response.json();

                if (result.success) {
                    // 触发浏览器保存密码
                    saveCredentials(username, password);
                    window.location.href = '/';
                } else {
                    errorMsg.textContent = result.error || '登录失败';
                    errorMsg.style.display = 'block';
                }
            } catch (err) {
                errorMsg.textContent = '网络错误，请重试';
                errorMsg.style.display = 'block';
            }
        });
        
        // 触发浏览器保存密码 (使用 Credential Management API)
        async function saveCredentials(username, password) {
            if (window.PasswordCredential) {
                try {
                    const credential = new PasswordCredential({
                        id: username,
                        password: password
                    });
                    await navigator.credentials.store(credential);
                } catch (e) {
                    // 忽略错误，不影响登录流程
                }
            }
        }
        
        // ==================== 扫码登录 ====================
        let qrcodeInstance = null;
        let pollingTimer = null;
        let currentToken = null;
        
        // 生成二维码
        async function initQRCode() {
            const container = document.getElementById('qrcodeContainer');
            const status = document.getElementById('qrcodeStatus');
            const refreshBtn = document.getElementById('refreshQR');
            const errorMsg = document.getElementById('qrErrorMsg');
            
            // 重置状态
            errorMsg.style.display = 'none';
            refreshBtn.style.display = 'none';
            container.innerHTML = '<div class="loading-spinner"></div>';
            status.innerHTML = '<p>正在生成二维码...</p>';
            
            try {
                // 创建二维码token
                const response = await fetch('/api/qrcode/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('生成二维码失败');
                }
                
                currentToken = result.token;
                
                // 构建扫码URL
                const qrUrl = `${window.location.origin}/qr-confirm/${result.token}`;
                
                // 生成二维码
                container.innerHTML = '';
                qrcodeInstance = new QRCode(container, {
                    text: qrUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#333333',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                status.innerHTML = '<p>请使用手机扫描二维码登录</p>';
                
                // 开始轮询状态
                startQRCodePolling(result.token);
                
            } catch (err) {
                container.innerHTML = '';
                status.innerHTML = '<p class="error-text">生成二维码失败</p>';
                refreshBtn.style.display = 'block';
            }
        }
        
        // 轮询二维码状态
        function startQRCodePolling(token) {
            stopQRCodePolling();
            
            pollingTimer = setInterval(async () => {
                try {
                    const response = await fetch(`/api/qrcode/status/${token}`);
                    const result = await response.json();
                    
                    const status = document.getElementById('qrcodeStatus');
                    const refreshBtn = document.getElementById('refreshQR');
                    
                    if (!result.success) {
                        status.innerHTML = '<p class="error-text">二维码已失效</p>';
                        refreshBtn.style.display = 'block';
                        stopQRCodePolling();
                        return;
                    }
                    
                    switch (result.status) {
                        case 'pending':
                            // 等待扫码
                            break;
                        case 'scanned':
                            status.innerHTML = '<p class="success-text">已扫描，请在手机上确认登录</p>';
                            break;
                        case 'confirmed':
                            status.innerHTML = '<p class="success-text">登录成功，正在跳转...</p>';
                            stopQRCodePolling();
                            // 设置sessionId cookie
                            document.cookie = `sessionId=${result.sessionId}; path=/; max-age=${7 * 24 * 60 * 60}`;
                            // 跳转首页
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 500);
                            break;
                        case 'cancelled':
                            status.innerHTML = '<p class="error-text">已取消登录</p>';
                            refreshBtn.style.display = 'block';
                            stopQRCodePolling();
                            break;
                        case 'expired':
                            status.innerHTML = '<p class="error-text">二维码已过期</p>';
                            refreshBtn.style.display = 'block';
                            stopQRCodePolling();
                            break;
                    }
                } catch (err) {
                    console.error('轮询状态失败:', err);
                }
            }, 1500); // 每1.5秒轮询一次
        }
        
        // 停止轮询
        function stopQRCodePolling() {
            if (pollingTimer) {
                clearInterval(pollingTimer);
                pollingTimer = null;
            }
        }
        
        // 刷新二维码
        document.getElementById('refreshQR').addEventListener('click', () => {
            initQRCode();
        });
        
        // ==================== PIN码登录 ====================
        const pinInputs = [
            document.getElementById('pinInput1'),
            document.getElementById('pinInput2'),
            document.getElementById('pinInput3'),
            document.getElementById('pinInput4')
        ];
        const pinLoginBtn = document.getElementById('pinLoginBtn');
        const pinErrorMsg = document.getElementById('pinErrorMsg');
        
        // PIN码输入框自动跳转
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                // 只允许数字
                if (!/^\d*$/.test(value)) {
                    e.target.value = '';
                    return;
                }
                // 自动跳转到下一个输入框
                if (value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
                // 4位数字输入完成后自动提交
                if (index === pinInputs.length - 1 && value) {
                    const pin = pinInputs.map(i => i.value).join('');
                    if (pin.length === 4) {
                        doPinLogin(pin);
                    }
                }
            });
            
            // 退格键处理
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });
            
            // 粘贴处理
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                const digits = pastedData.replace(/\D/g, '').slice(0, 4);
                
                digits.split('').forEach((digit, i) => {
                    if (pinInputs[i]) {
                        pinInputs[i].value = digit;
                    }
                });
                
                if (digits.length === 4) {
                    doPinLogin(digits);
                } else if (digits.length > 0) {
                    pinInputs[Math.min(digits.length, 3)].focus();
                }
            });
        });
        
        // PIN码登录按钮点击
        pinLoginBtn.addEventListener('click', () => {
            const pin = pinInputs.map(i => i.value).join('');
            if (pin.length === 4) {
                doPinLogin(pin);
            } else {
                pinErrorMsg.textContent = '请输入完整的4位PIN码';
                pinErrorMsg.style.display = 'block';
            }
        });
        
        // 执行PIN码登录
        async function doPinLogin(pin) {
            pinErrorMsg.style.display = 'none';
            pinLoginBtn.disabled = true;
            pinLoginBtn.textContent = '登录中...';
            
            try {
                const response = await fetch('/api/pin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin }),
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = '/';
                } else {
                    pinErrorMsg.textContent = result.error || 'PIN码无效';
                    pinErrorMsg.style.display = 'block';
                    // 清空输入框
                    pinInputs.forEach(input => input.value = '');
                    pinInputs[0].focus();
                }
            } catch (err) {
                pinErrorMsg.textContent = '网络错误，请重试';
                pinErrorMsg.style.display = 'block';
            } finally {
                pinLoginBtn.disabled = false;
                pinLoginBtn.textContent = '登录';
            }
        }
        
        // 页面卸载时停止轮询
        window.addEventListener('beforeunload', stopQRCodePolling);
    </script>
</body>
</html>
